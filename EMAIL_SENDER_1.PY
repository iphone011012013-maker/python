import customtkinter as ctk
import smtplib
import threading
import time
import os
from tkinter import filedialog, messagebox
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders

# --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¸Ù‡Ø± ---
ctk.set_appearance_mode("Dark")
ctk.set_default_color_theme("dark-blue")

class MarketingToolApp(ctk.CTk):
    def __init__(self):
        super().__init__()

        self.title("AboElfadl Media | Marketing Sender Pro v2.0")
        self.geometry("850x700") # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¬Ù… Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        self.resizable(False, False)

        # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„
        self.email_list = []
        self.html_content = ""
        self.attachment_path = None # Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
        self.running = False
        self.total_sent = 0
        self.total_failed = 0

        # --- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ---
        self.header = ctk.CTkLabel(
            self, 
            text="ğŸ“§ AboElfadl Marketing Sender", 
            font=("Segoe UI", 24, "bold"),
            text_color="#3B8ED0"
        )
        self.header.pack(pady=15)

        # --- (1) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„ (SMTP) ---
        self.frame_smtp = ctk.CTkFrame(self)
        self.frame_smtp.pack(pady=5, padx=20, fill="x")

        ctk.CTkLabel(self.frame_smtp, text="Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„ (SMTP Config)", font=("Arial", 14, "bold")).pack(pady=5)
        
        self.sender_email = ctk.CTkEntry(self.frame_smtp, placeholder_text="Email (Gmail)", width=300)
        self.sender_email.pack(pady=5)
        self.sender_email.insert(0, "iphone011012013@gmail.com") 

        self.sender_pass = ctk.CTkEntry(self.frame_smtp, placeholder_text="App Password", width=300, show="*")
        self.sender_pass.pack(pady=5)
        self.sender_pass.insert(0, "qrpf wkub heck bnbi")

        # --- (2) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø© (Campaign) ---
        self.frame_campaign = ctk.CTkFrame(self)
        self.frame_campaign.pack(pady=10, padx=20, fill="x")

        ctk.CTkLabel(self.frame_campaign, text="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª", font=("Arial", 14, "bold")).pack(pady=5)

        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        self.subject_entry = ctk.CTkEntry(self.frame_campaign, placeholder_text="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Subject Line)", width=450)
        self.subject_entry.pack(pady=5)

        # Ø£Ø²Ø±Ø§Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        self.files_frame = ctk.CTkFrame(self.frame_campaign, fg_color="transparent")
        self.files_frame.pack(pady=5)

        # Ø²Ø± Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        self.btn_load_emails = ctk.CTkButton(self.files_frame, text="ğŸ“‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (.txt)", command=self.load_emails_file, width=120)
        self.btn_load_emails.pack(side="left", padx=5)

        # Ø²Ø± Ø±ÙØ¹ Ø§Ù„ØªØµÙ…ÙŠÙ…
        self.btn_load_html = ctk.CTkButton(self.files_frame, text="ğŸ¨ Ø§Ù„ØªØµÙ…ÙŠÙ… (.html)", command=self.load_html_file, fg_color="#D35400", hover_color="#A04000", width=120)
        self.btn_load_html.pack(side="left", padx=5)

        # Ø²Ø± Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù (Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        self.btn_attach_file = ctk.CTkButton(self.files_frame, text="ğŸ“ Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù", command=self.select_attachment, fg_color="#5B2C6F", hover_color="#4A235A", width=120)
        self.btn_attach_file.pack(side="left", padx=5)

        # Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ù„ÙØ§Øª
        self.lbl_status_files = ctk.CTkLabel(self.frame_campaign, text="Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª...", text_color="gray", wraplength=700)
        self.lbl_status_files.pack(pady=5)

        # --- (3) Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ ---
        self.frame_controls = ctk.CTkFrame(self, fg_color="transparent")
        self.frame_controls.pack(pady=5)

        self.delay_slider = ctk.CTkSlider(self.frame_controls, from_=2, to=30, number_of_steps=28, width=200)
        self.delay_slider.set(5)
        self.delay_slider.pack(side="left", padx=10)
        
        self.lbl_delay = ctk.CTkLabel(self.frame_controls, text="ÙÙˆØ§ØµÙ„: 5 Ø«")
        self.lbl_delay.pack(side="left", padx=5)
        
        self.delay_slider.configure(command=lambda val: self.lbl_delay.configure(text=f"ÙÙˆØ§ØµÙ„: {int(val)} Ø«"))

        self.start_btn = ctk.CTkButton(self.frame_controls, text="ğŸš€ Ø¥Ø±Ø³Ø§Ù„", command=self.start_thread, fg_color="green", hover_color="darkgreen", width=100)
        self.start_btn.pack(side="left", padx=20)

        self.stop_btn = ctk.CTkButton(self.frame_controls, text="ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù", command=self.stop_process, fg_color="red", hover_color="darkred", state="disabled", width=80)
        self.stop_btn.pack(side="left", padx=5)

        # --- Ø§Ù„Ø³Ø¬Ù„ (Log) ---
        self.log_box = ctk.CTkTextbox(self, width=750, height=200, font=("Consolas", 12))
        self.log_box.pack(pady=10, padx=20, fill="both", expand=True)

    def log(self, text):
        self.log_box.insert("end", text + "\n")
        self.log_box.see("end")

    def update_status_label(self):
        # Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©
        status_text = ""
        if self.email_list: status_text += f"âœ… Ù‚Ø§Ø¦Ù…Ø©: {len(self.email_list)} | "
        if self.html_content: status_text += "âœ… HTML | "
        if self.attachment_path: status_text += f"ğŸ“ Ù…Ø±ÙÙ‚: {os.path.basename(self.attachment_path)}"
        
        if status_text == "": status_text = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª..."
        self.lbl_status_files.configure(text=status_text, text_color="lightgreen" if status_text else "gray")

    def load_emails_file(self):
        file_path = filedialog.askopenfilename(filetypes=[("Text Files", "*.txt")])
        if file_path:
            with open(file_path, "r", encoding="utf-8") as f:
                self.email_list = [line.strip() for line in f.readlines() if line.strip()]
            self.log(f"ğŸ“‚ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: {len(self.email_list)} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„.")
            self.update_status_label()

    def load_html_file(self):
        file_path = filedialog.askopenfilename(filetypes=[("HTML Files", "*.html")])
        if file_path:
            with open(file_path, "r", encoding="utf-8") as f:
                self.html_content = f.read()
            self.log("ğŸ¨ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªØµÙ…ÙŠÙ… HTML.")
            self.update_status_label()

    def select_attachment(self):
        # Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚
        file_path = filedialog.askopenfilename()
        if file_path:
            self.attachment_path = file_path
            self.log(f"ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙÙ‚: {os.path.basename(file_path)}")
            self.update_status_label()

    def start_thread(self):
        if not self.email_list:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ Ø±ÙØ¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.")
            return
        if not self.subject_entry.get():
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ø±Ø³Ø§Ù„Ø©.")
            return
        
        if not self.running:
            self.running = True
            self.start_btn.configure(state="disabled")
            self.stop_btn.configure(state="normal")
            
            threading.Thread(target=self.process_sending, daemon=True).start()

    def stop_process(self):
        self.running = False
        self.log("âš ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù...")

    def process_sending(self):
        sender = self.sender_email.get()
        password = self.sender_pass.get()
        subject = self.subject_entry.get()
        delay = int(self.delay_slider.get())

        self.log("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„ÙØ§Øª...")

        try:
            # ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø±ÙÙ‚ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡)
            attachment_part = None
            if self.attachment_path:
                try:
                    with open(self.attachment_path, "rb") as attachment:
                        attachment_part = MIMEBase("application", "octet-stream")
                        attachment_part.set_payload(attachment.read())
                    encoders.encode_base64(attachment_part)
                    attachment_part.add_header(
                        "Content-Disposition",
                        f"attachment; filename= {os.path.basename(self.attachment_path)}",
                    )
                except Exception as e:
                    self.log(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø±ÙÙ‚: {e}")
                    self.reset_buttons()
                    return

            server = smtplib.SMTP('smtp.gmail.com', 587)
            server.starttls()
            server.login(sender, password.replace(" ", ""))
            self.log("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„. Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©...")

            for index, target_email in enumerate(self.email_list):
                if not self.running:
                    break

                msg = MIMEMultipart()
                msg['From'] = f"AboElfadl Media <{sender}>"
                msg['To'] = target_email
                msg['Subject'] = subject

                # 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (HTML Ø£Ùˆ Ù†Øµ)
                if self.html_content:
                    msg.attach(MIMEText(self.html_content, 'html', 'utf-8'))
                else:
                    msg.attach(MIMEText("This is a message from AboElfadl Media.", 'plain', 'utf-8'))

                # 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙÙ‚ (Ø¥Ø°Ø§ ÙˆØ¬Ø¯)
                if attachment_part:
                    # ÙŠØ¬Ø¨ Ù†Ø³Ø® Ø§Ù„ÙƒØ§Ø¦Ù† Ù„Ø£Ù† Ø¨Ø¹Ø¶ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª ØªØ¹Ø¯Ù„ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                    # Ù„ÙƒÙ† ÙÙŠ Ø¨Ø§ÙŠØ«ÙˆÙ† ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ØŒ Ù„Ù„Ø£Ù…Ø§Ù† Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø±ÙØ§Ù‚Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
                    msg.attach(attachment_part)

                try:
                    server.sendmail(sender, target_email, msg.as_string())
                    self.total_sent += 1
                    self.log(f"âœ… ({index+1}/{len(self.email_list)}) ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€: {target_email}")
                except Exception as e:
                    self.total_failed += 1
                    self.log(f"âŒ ÙØ´Ù„ ({target_email}): {e}")

                time.sleep(delay)

            server.quit()
            self.log(f"\nğŸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: âœ… {self.total_sent} | âŒ {self.total_failed}")

        except Exception as e:
            self.log(f"â›” Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: {e}")

        self.reset_buttons()

    def reset_buttons(self):
        self.running = False
        self.start_btn.configure(state="normal")
        self.stop_btn.configure(state="disabled")

if __name__ == "__main__":
    app = MarketingToolApp()
    app.mainloop()