import customtkinter as ctk
import smtplib
import threading
import time
import os
from tkinter import filedialog, messagebox
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders

# --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¸Ù‡Ø± ---
ctk.set_appearance_mode("Dark")
ctk.set_default_color_theme("blue")

class MarketingToolApp(ctk.CTk):
    def __init__(self):
        super().__init__()

        self.title("AboElfadl Media | Marketing Sender Pro v3.0")
        self.geometry("850x750")
        self.resizable(False, False)

        # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„
        self.email_list = []
        self.html_content = ""
        self.attachment_path = None
        self.running = False
        self.total_sent = 0
        self.total_failed = 0

        # --- (1) Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ---
        self.header_frame = ctk.CTkFrame(self, fg_color="transparent")
        self.header_frame.pack(pady=10)
        
        # Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù†Øµ Ø«Ø§Ø¨Øª)
        self.app_title_entry = ctk.CTkEntry(
            self.header_frame, 
            font=("Segoe UI", 22, "bold"), 
            width=400, 
            fg_color="transparent", 
            border_width=0, 
            justify="center",
            text_color="#3B8ED0"
        )
        self.app_title_entry.pack()
        self.app_title_entry.insert(0, "AboElfadl Marketing Sender") # Ø§Ù„Ù†Øµ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

        # --- (2) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„ ÙˆØ§Ù„Ù‡ÙˆÙŠØ© ---
        self.frame_config = ctk.CTkFrame(self)
        self.frame_config.pack(pady=5, padx=20, fill="x")

        ctk.CTkLabel(self.frame_config, text="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù„Ø§ØªØµØ§Ù„", font=("Arial", 13, "bold")).pack(pady=5)
        
        # Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
        self.row1 = ctk.CTkFrame(self.frame_config, fg_color="transparent")
        self.row1.pack(pady=2)
        
        self.sender_email = ctk.CTkEntry(self.row1, placeholder_text="Ø§Ù„Ø¨Ø±ÙŠØ¯ (Gmail)", width=280)
        self.sender_email.pack(side="left", padx=5)
        self.sender_email.insert(0, "iphone011012013@gmail.com") 

        self.sender_pass = ctk.CTkEntry(self.row1, placeholder_text="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚", width=280, show="*")
        self.sender_pass.pack(side="left", padx=5)
        self.sender_pass.insert(0, "qrpf wkub heck bnbi")

        # Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ (Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        self.row2 = ctk.CTkFrame(self.frame_config, fg_color="transparent")
        self.row2.pack(pady=5)

        ctk.CTkLabel(self.row2, text="Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ (ÙƒÙ…Ø§ ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„):").pack(side="left", padx=5)
        self.display_name_entry = ctk.CTkEntry(self.row2, placeholder_text="Ù…Ø«Ø§Ù„: AboElfadl Support", width=300)
        self.display_name_entry.pack(side="left", padx=5)
        self.display_name_entry.insert(0, "AboElfadl Media")

        # --- (3) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù… (ÙŠØ¯ÙˆÙŠ Ø£Ùˆ Ù…Ù„Ù) ---
        self.frame_target = ctk.CTkFrame(self)
        self.frame_target.pack(pady=10, padx=20, fill="x")

        ctk.CTkLabel(self.frame_target, text="ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†", font=("Arial", 13, "bold")).pack(pady=5)

        # -- Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯) --
        self.manual_frame = ctk.CTkFrame(self.frame_target, fg_color="transparent")
        self.manual_frame.pack(pady=5)

        self.manual_email_entry = ctk.CTkEntry(self.manual_frame, placeholder_text="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªÙ„Ù… ÙˆØ§Ø­Ø¯ Ù‡Ù†Ø§...", width=350)
        self.manual_email_entry.pack(side="left", padx=5)

        # Ø²Ø± Ø§Ù„Ù„ØµÙ‚ (Paste)
        self.btn_paste = ctk.CTkButton(self.manual_frame, text="ğŸ“‹ Ù„ØµÙ‚", width=60, command=self.paste_from_clipboard, fg_color="#555", hover_color="#333")
        self.btn_paste.pack(side="left", padx=5)

        # -- Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù --
        self.file_btn_frame = ctk.CTkFrame(self.frame_target, fg_color="transparent")
        self.file_btn_frame.pack(pady=5)
        
        self.btn_load_emails = ctk.CTkButton(self.file_btn_frame, text="ğŸ“‚ Ø£Ùˆ Ø§Ø±ÙØ¹ Ù‚Ø§Ø¦Ù…Ø© (.txt)", command=self.load_emails_file, width=200)
        self.btn_load_emails.pack()

        # Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        self.lbl_list_status = ctk.CTkLabel(self.frame_target, text="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© (Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙÙ‚Ø·)", text_color="gray", font=("Arial", 11))
        self.lbl_list_status.pack(pady=2)

        # --- (4) Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª ---
        self.frame_content = ctk.CTkFrame(self)
        self.frame_content.pack(pady=10, padx=20, fill="x")

        self.subject_entry = ctk.CTkEntry(self.frame_content, placeholder_text="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Subject Line)", width=500)
        self.subject_entry.pack(pady=10)

        self.attach_frame = ctk.CTkFrame(self.frame_content, fg_color="transparent")
        self.attach_frame.pack(pady=5)

        self.btn_load_html = ctk.CTkButton(self.attach_frame, text="ğŸ¨ ØªØµÙ…ÙŠÙ… HTML", command=self.load_html_file, fg_color="#D35400", hover_color="#A04000")
        self.btn_load_html.pack(side="left", padx=10)

        self.btn_attach_file = ctk.CTkButton(self.attach_frame, text="ğŸ“ Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù", command=self.select_attachment, fg_color="#5B2C6F", hover_color="#4A235A")
        self.btn_attach_file.pack(side="left", padx=10)

        self.lbl_files_status = ctk.CTkLabel(self.frame_content, text="", text_color="lightgreen", font=("Arial", 11))
        self.lbl_files_status.pack(pady=2)

        # --- Ø§Ù„ØªØ­ÙƒÙ… ---
        self.controls_frame = ctk.CTkFrame(self, fg_color="transparent")
        self.controls_frame.pack(pady=5)

        self.delay_slider = ctk.CTkSlider(self.controls_frame, from_=2, to=30, number_of_steps=28, width=200)
        self.delay_slider.set(5)
        self.delay_slider.pack(side="left", padx=10)
        self.lbl_delay = ctk.CTkLabel(self.controls_frame, text="ÙÙˆØ§ØµÙ„: 5 Ø«")
        self.lbl_delay.pack(side="left")
        self.delay_slider.configure(command=lambda val: self.lbl_delay.configure(text=f"ÙÙˆØ§ØµÙ„: {int(val)} Ø«"))

        self.start_btn = ctk.CTkButton(self.controls_frame, text="ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†", command=self.start_thread, fg_color="green", hover_color="darkgreen", width=120, height=35)
        self.start_btn.pack(side="left", padx=20)

        self.stop_btn = ctk.CTkButton(self.controls_frame, text="Ø¥ÙŠÙ‚Ø§Ù", command=self.stop_process, fg_color="red", hover_color="darkred", state="disabled", width=60)
        self.stop_btn.pack(side="left", padx=5)

        # --- Ø§Ù„Ø³Ø¬Ù„ ---
        self.log_box = ctk.CTkTextbox(self, width=800, height=150, font=("Consolas", 11))
        self.log_box.pack(pady=10, padx=20, fill="both", expand=True)

    # --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ---
    def log(self, text):
        self.log_box.insert("end", text + "\n")
        self.log_box.see("end")

    def paste_from_clipboard(self):
        try:
            # Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø© ÙˆÙ„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
            text = self.clipboard_get()
            self.manual_email_entry.delete(0, 'end')
            self.manual_email_entry.insert(0, text)
            self.log(f"ğŸ“‹ ØªÙ… Ù„ØµÙ‚: {text}")
        except:
            self.log("âš ï¸ Ø§Ù„Ø­Ø§ÙØ¸Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ.")

    def load_emails_file(self):
        file_path = filedialog.askopenfilename(filetypes=[("Text Files", "*.txt")])
        if file_path:
            with open(file_path, "r", encoding="utf-8") as f:
                self.email_list = [line.strip() for line in f.readlines() if line.strip()]
            self.lbl_list_status.configure(text=f"âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: {len(self.email_list)} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„")
            self.log(f"ğŸ“‚ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: {len(self.email_list)} Ù…Ø³ØªÙ„Ù….")

    def load_html_file(self):
        file_path = filedialog.askopenfilename(filetypes=[("HTML Files", "*.html")])
        if file_path:
            with open(file_path, "r", encoding="utf-8") as f:
                self.html_content = f.read()
            self.lbl_files_status.configure(text=self.lbl_files_status.cget("text") + " [HTML Loaded] ")
            self.log("ğŸ¨ ØªÙ… ØªØ­Ù…ÙŠÙ„ HTML.")

    def select_attachment(self):
        file_path = filedialog.askopenfilename()
        if file_path:
            self.attachment_path = file_path
            self.lbl_files_status.configure(text=self.lbl_files_status.cget("text") + f" [Ù…Ù„Ù: {os.path.basename(file_path)}] ")
            self.log(f"ğŸ“ Ù…Ø±ÙÙ‚: {os.path.basename(file_path)}")

    def start_thread(self):
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªÙ„Ù… (Ø¥Ù…Ø§ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ ÙŠØ¯ÙˆÙŠ)
        manual_target = self.manual_email_entry.get().strip()
        
        if not self.email_list and not manual_target:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙ„Ù… (Ø§ÙƒØªØ¨ Ø¥ÙŠÙ…ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ Ø§Ø±ÙØ¹ Ù‚Ø§Ø¦Ù…Ø©).")
            return
        
        if not self.subject_entry.get():
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø·Ù„ÙˆØ¨.")
            return

        if not self.running:
            self.running = True
            self.start_btn.configure(state="disabled")
            self.stop_btn.configure(state="normal")
            threading.Thread(target=self.process_sending, daemon=True).start()

    def stop_process(self):
        self.running = False
        self.log("âš ï¸ Ø¥ÙŠÙ‚Ø§Ù...")

    def process_sending(self):
        sender_addr = self.sender_email.get()
        sender_pass = self.sender_pass.get()
        display_name = self.display_name_entry.get() # Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        subject = self.subject_entry.get()
        delay = int(self.delay_slider.get())
        
        # ØªØ¬Ù…ÙŠØ¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© + Ø§Ù„ÙŠØ¯ÙˆÙŠ)
        targets = self.email_list.copy()
        manual_target = self.manual_email_entry.get().strip()
        if manual_target:
            targets.append(manual_target)
            # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¥Ù† ÙˆØ¬Ø¯
            targets = list(set(targets))

        self.log(f"ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø¯Ø¡... Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: {len(targets)}")

        try:
            # ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø±ÙÙ‚
            attachment_part = None
            if self.attachment_path:
                try:
                    with open(self.attachment_path, "rb") as f:
                        attachment_part = MIMEBase("application", "octet-stream")
                        attachment_part.set_payload(f.read())
                    encoders.encode_base64(attachment_part)
                    attachment_part.add_header("Content-Disposition", f"attachment; filename={os.path.basename(self.attachment_path)}")
                except Exception as e:
                    self.log(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø±ÙÙ‚: {e}")
                    self.reset_buttons()
                    return

            server = smtplib.SMTP('smtp.gmail.com', 587)
            server.starttls()
            server.login(sender_addr, sender_pass.replace(" ", ""))
            self.log("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.")

            for i, target in enumerate(targets):
                if not self.running: break

                msg = MIMEMultipart()
                # Ù‡Ù†Ø§ ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØµØµ
                msg['From'] = f"{display_name} <{sender_addr}>"
                msg['To'] = target
                msg['Subject'] = subject

                if self.html_content:
                    msg.attach(MIMEText(self.html_content, 'html', 'utf-8'))
                else:
                    msg.attach(MIMEText("Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù….", 'plain', 'utf-8'))

                if attachment_part:
                    msg.attach(attachment_part)

                try:
                    server.sendmail(sender_addr, target, msg.as_string())
                    self.total_sent += 1
                    self.log(f"ğŸ“¤ ({i+1}/{len(targets)}) ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€: {target}")
                except Exception as e:
                    self.total_failed += 1
                    self.log(f"âŒ Ø®Ø·Ø£ Ù…Ø¹ {target}: {e}")

                time.sleep(delay)

            server.quit()
            self.log(f"ğŸ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡. Ù†Ø¬Ø§Ø­: {self.total_sent} | ÙØ´Ù„: {self.total_failed}")

        except Exception as e:
            self.log(f"â›” Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: {e}")

        self.reset_buttons()

    def reset_buttons(self):
        self.running = False
        self.start_btn.configure(state="normal")
        self.stop_btn.configure(state="disabled")

if __name__ == "__main__":
    app = MarketingToolApp()
    app.mainloop()